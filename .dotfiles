#!/bin/sh

echo "no"
exit 0

# this script is an attempt of automating my symlink hell before
# i know Stow existed

this_script_dir="$( dirname "$( realpath "$0" )" )"

_help() {
    cat <<EOF
dotfile symlink manager

Usage:
    add     Move a file to this repo and create a symlink at its original location
    ln      Create a symlink
EOF
}

_add() {
    file=$1
    path_from_home=$( echo "$file" | sed -e "s|$HOME/||" )
    this_repo="$this_script_dir/$path_from_home"

    if [ ! -e "$file" ]; then
        echo "dotfiles.sh: '$file' does not exist" 1>&2
        exit 1
    fi
    if [ -L "$file" ]; then
        echo "dotfiles.sh: '$file' already is a symbolic link to '$this_repo'"
        exit 0
    fi

    mv -T "$file" "$this_repo"
    ln -s -T "$this_repo" "$file"
    exit 0
}

_ln() {
     file="$1"
     target_dir="$2"

     source_file="$this_script_dir/$file"
     target_file="$target_dir/$file"

    # symlink was already created before: do nothing
    if [ -L "$target_file" ] && [ "$(readlink "$target_file")" = "$source_file" ]; then
        echo "dotfiles: $target_file: symlink already created"
        exit 0
    fi

    if [ ! -e "$target_dir" ]; then
        mkdir -pv "$target_dir"
    fi

    # prompt user for overwriting existing target file
    if [ -e "$target_file" ]; then
        if [ -L "$target_file" ]; then
            echo "'$target_file' is linked to '$( readlink "$target_file" )'"
        elif [ -d "$target_file" ]; then
            echo "dotfiles: $target_file: cannot overwrite directory" 1>&2
            exit 1
        else
            echo "'$target_file' is a regular file"
        fi

        while true; do
            echo "Do you wish to overwrite it? (y/N) "
            read -r yn
            case $yn in
                [nN]|"") 
                    echo "Abort syncing"
                    exit 0;;
                [yY]) break;;
                *) echo "Not a valid answer."
            esac
        done
    fi

    ln -sfTv "$source_file" "$target_file"
    exit 0
 }

 _test() {
    echo "$(pwd)/$(dirname "$0")"
 }

if [ "$(dirname "$0")" != "." ]; then
    echo "You may want to cd to ~/.dotfiles for file path completion."
fi

case $1 in
    "test")
        _test;;
    "add")
        _add "$2";;
    "ln")
        _ln "$2" "$3";;
    "")
        _help;;
    *)
        echo "Invalid option: $1";;
esac

# while getopts "h" opt; do
#     case $opt in
#     \?)
#         echo "weird opt";;
#     h)
#         echo "h was called";;
#     esac
# done

unset this_script_dir
